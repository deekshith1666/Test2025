name: Deploy to k3s

on:
  push:
    branches: [ "main" ]

env:
  ACTIONS_STEP_DEBUG: true
  ACTIONS_RUNNER_DEBUG: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install kubectl
        run: |
          sudo apt-get update
          sudo apt-get install -y kubectl

      - name: Create kubeconfig file
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_DATA }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Test cluster connectivity
        run: |
          kubectl --kubeconfig ~/.kube/config get nodes

      - name: Apply Kubernetes manifests
        run: |
          kubectl --kubeconfig ~/.kube/config apply -f deployment.yml

      - name: Verify deployment
        run: |
          kubectl --kubeconfig ~/.kube/config get all
      
      - name: Wait for NodePort availability
        run: |
          echo "Waiting for NodePort to be assigned..."
          for i in {1..20}; do
            NODE_PORT=$(kubectl --kubeconfig ~/.kube/config get svc hello-service -o jsonpath='{.spec.ports[0].nodePort}')
            if [[ -n "$NODE_PORT" ]]; then
              echo "NodePort available: $NODE_PORT"
              echo "Application URL: http://3.238.251.9:$NODE_PORT"
              exit 0
            fi
            echo "Still waiting..."
            sleep 5
          done
          
          echo "Timed out waiting for NodePort!"
          exit 1
